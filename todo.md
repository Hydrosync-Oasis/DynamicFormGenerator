# 实现`useSyncExternalStore` + 生成不可变快照

==已完成==

表单生成器的内部结构在`FormModel`的一个字段`CompiledData`里，这个状态对象是要导出一个快照的**不可变对象**，需要做以下修改：

1. 规则没有从这个树中抽出来，需要单独抽出来，让这个状态更干净（因为规则不应该发生变化，是定的；规则只应该绑定给静态字段节点，也就是数组型字段的后代字段不能绑定规则）；
2. 校验对象也需要从树中抽出，因为和UI无关。和UI有关的是`errorMessage`。
3. 不应该有`rootArrayField`
4. `cache`删掉



# 实现原地设置数组值

==已完成==

**意义：**
保留`visible`，同时也能增强效率，未来可实现在数据没有变化时不触发渲染。

**分析：**

1. 对象型嵌套字段是全部静态的，仅和`schema`有关。
   - 这里可以直接在原地递归，直接设置
2. 数组型嵌套字段是动态的，和**值**有关。
   - 需要找到同key的子字段，递归进行设置



# 实现多套校验规则

==已完成==

**意义：**
处理不同时机下的自定义校验，`onChange`，`onBlur`，`onSubmit`，以及一些自定义校验时机下的规则，这些不同时机执行的规则可能都**不同**。

**分析：**
提交时应应用所有校验规则



# 自定义UI组件需要接收一个`ctx`的prop

==已完成==

**意义：**
实现在UI上通过用户自定义按钮触发回调函数以控制表单状态，如“点击按钮新增一项”。

# 实现事务

**意义：**
统一管理`notify()`调用。



# 实现字段状态管理

**意义：**
区分字段来源，区分是用户填写，来自数据源，还是默认值。
展示字段是否被修改过。

**分析：**

1. 思考嵌套字段要不要维护该状态；需要
   1. 是**深比较**。
   2. 每个节点的`NodeCache`中存放字段是否是dirty，有三种状态：`unknown`，`dirty`，`clean`。`unknown`说明该缓存过期。
      当值发生变化的时候缓存失效，需要时才重新计算缓存。
   3. 增加一个与`visible`正交的属性`includePolicy: 'always' | 'whenVisible' | 'never'`，以增强对字段在提交时是否包含的控制。
   4. 深比较时，从表单的每个字段的`visible`和`includePolicy`来出发，若会被包含在最终提交数据上，但`initialValue`里没有该属性，直接标记为`dirty`（反之亦然），否则递归向下比对值，若该嵌套字段下每个成员都比对成功，整个字段的`dirty`都是`false`。
2. 在`ctx`增加*未显式填写时设置默认值*的API，提供手动输入`dirty`的参数让用户选择是否应该是脏数据，待提交给后端